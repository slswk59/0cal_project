<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
    <mapper namespace="shopping">
    <!-- 상품관련 -->
	<select id="productCount" resultType="int">
		SELECT count(*) FROM product
	</select>
	
	<select id="selectOneProduct" parameterType="int" resultType="shopping.dto.ProductDTO">
		SELECT * FROM product WHERE pr_key=#{pr_key}
	</select>
	

	<select id="productNewList" parameterType="shopping.dto.PageDTO" resultType="shopping.dto.ProductDTO">
		<![CDATA[ 
		SELECT b.*
			FROM(SELECT rownum AS rm, a.*
                FROM(SELECT * FROM product 
                ORDER BY pr_reg_date desc)a
                )b
		WHERE b.rm>=#{startRow} AND b.rm<=#{endRow}
		]]>
	</select>
	
	<select id="productSaleList" parameterType="shopping.dto.PageDTO" resultType="shopping.dto.ProductDTO">
		<![CDATA[ 
		SELECT b.*
			FROM(SELECT rownum AS rm, a.*
                FROM(SELECT * FROM product 
                ORDER BY pr_dcper desc)a
                )b
		WHERE b.rm>=#{startRow} AND b.rm<=#{endRow}
		]]>
	</select>
	
	<select id="productthemeList_drama" parameterType="shopping.dto.PageDTO" resultType="shopping.dto.ProductDTO">
		<![CDATA[ 
		SELECT b.*
			FROM(SELECT rownum AS rm, a.*
                FROM(SELECT * FROM product 
                WHERE pr_theme='드라마정주행')a
                )b
		WHERE b.rm>=#{startRow} AND b.rm<=#{endRow}
		]]>
	</select>
	
	<select id="productthemeList_organic" parameterType="shopping.dto.PageDTO" resultType="shopping.dto.ProductDTO">
		<![CDATA[ 
		SELECT b.*
			FROM(SELECT rownum AS rm, a.*
                FROM(SELECT * FROM product 
                WHERE pr_theme='올가닉제품')a
                )b
		WHERE b.rm>=#{startRow} AND b.rm<=#{endRow}
		]]>
	</select>
	
	<!-- 상품 구입횟수가 많은 상품은 추후 구현! 어려움. 구매횟수가 많은 것 -->
	<!-- 상품 검색어 기능은 추후 구현! 너무 어려움. -->


	<!-- 구매내역관련 -->
	 <resultMap type="shopping.dto.OrdersDTO" id="listSelect" autoMapping="true">
		<association property="memberDTO" javaType="member.dto.MemberDTO">
			<result column="id" property="id"/>
		</association>
		<association property="productDTO" javaType="shopping.dto.ProductDTO">
			<result column="pr_name" property="pr_name"/>
			<result column="pr_thumbnail" property="pr_thumbnail"/>
		</association>
	</resultMap>
	
	<select id="orderlist" parameterType="String" resultMap="listSelect">
			SELECT * 
			FROM(SELECT o.id, o.or_key, o.or_price, o.or_date, t.pr_key, p.pr_name, p.pr_thumbnail,
		    ROW_NUMBER() OVER(PARTITION BY o.or_key ORDER BY t.pr_key DESC) AS RankNO
			FROM orders o, or_detail t, product p
			WHERE o.or_key = t.or_key AND p.pr_key = t.pr_key AND o.id=#{id}
			) WHERE RankNO = 1
	</select>


	<resultMap type="shopping.dto.OrdersDTO" id="detailListSelect" autoMapping="true">
		<association property="productDTO" javaType="shopping.dto.ProductDTO">
			<result column="pr_name" property="pr_name"/>
			<result column="pr_thumbnail" property="pr_thumbnail"/>
			<result column="pr_price" property="pr_price"/>
			<result column="pr_dcprice" property="pr_dcprice"/>
		</association>
		<association property="or_detailDTO" javaType="shopping.dto.Or_detailDTO">
			<result column="or_detail_key" property="or_detail_key"/>
			<result column="or_pr_count" property="or_pr_count"/>
		</association>
	</resultMap>
	
	<select id="orderDetailList" parameterType="int" resultMap="detailListSelect">
			SELECT o.or_key, t.or_detail_key, t.or_pr_count,
		    p.pr_name, p.pr_thumbnail, p.pr_price, p.pr_dcprice
			FROM orders o, or_detail t, product p
			WHERE o.or_key = t.or_key AND p.pr_key = t.pr_key AND o.or_key=#{or_key}
			ORDER BY or_detail_key ASC, or_date ASC
	</select>

</mapper>